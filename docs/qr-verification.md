# QR Code Invoice Verification

## Overview

Every invoice PDF generated by SuoOps now includes a QR code that customers can scan to instantly verify the invoice's authenticity and check its payment status.

## Features

### ‚úÖ What's Included

- **QR Code on PDF**: Automatically embedded in every invoice PDF
- **Public Verification**: No authentication required - anyone can scan and verify
- **Privacy Protection**: Customer names are masked (e.g., "J*** D***")
- **Real-time Status**: Shows current payment status (pending, paid, failed)
- **Anti-fraud**: Proves invoice is legitimate and from your business

### üîê Security & Privacy

- **No Authentication Required**: Public endpoint for easy verification
- **Masked Customer Info**: Only shows first and last letter (e.g., "Jane Doe" ‚Üí "J***e")
- **Business Information**: Shows your business name for transparency
- **Timestamp**: Includes when invoice was created and verified

## How It Works

### 1. Invoice Generation
When an invoice is created:
```python
# QR code is automatically generated with verification URL
verify_url = f"https://api.suoops.com/invoices/{invoice_id}/verify"
```

### 2. PDF Generation
The QR code is embedded in the invoice PDF template:
```html
<div class="qr-section">
  <h3>üîê Verify Authenticity</h3>
  <img src="{{ qr_code }}" alt="Scan to verify invoice" />
  <p><strong>Scan QR code to verify this invoice is genuine</strong></p>
</div>
```

### 3. Customer Verification
Customer scans QR code ‚Üí Opens verification URL ‚Üí Sees invoice details:

```json
{
  "invoice_id": "INV-2025-001",
  "status": "paid",
  "amount": "50000",
  "customer_name": "J*** D***",
  "business_name": "Your Business Name",
  "created_at": "2025-10-30T10:00:00Z",
  "verified_at": "2025-10-30T12:30:00Z",
  "authentic": true
}
```

## API Endpoint

### GET `/invoices/{invoice_id}/verify`

**Public endpoint** - No authentication required

#### Request
```bash
curl https://api.suoops.com/invoices/INV-2025-001/verify
```

#### Response (200 OK)
```json
{
  "invoice_id": "INV-2025-001",
  "status": "paid",
  "amount": "50000",
  "customer_name": "J*** D***",
  "business_name": "Acme Design Studio",
  "created_at": "2025-10-30T10:00:00Z",
  "verified_at": "2025-10-30T12:30:45Z",
  "authentic": true
}
```

#### Response (404 Not Found)
```json
{
  "detail": "Invoice not found"
}
```

## Use Cases

### 1. Customer Trust
**Problem**: Customer receives invoice but isn't sure if it's legitimate
**Solution**: Scan QR code to verify invoice is from your business

### 2. Fraud Prevention
**Problem**: Fake invoices impersonating your business
**Solution**: Only your real invoices have valid QR codes

### 3. Payment Status Check
**Problem**: Customer wants to check if payment was received
**Solution**: Scan QR code to see current status (paid/pending)

### 4. Audit Trail
**Problem**: Need to verify invoice authenticity for accounting
**Solution**: QR code provides instant verification without contacting business

## Implementation Details

### Backend Components

1. **QR Code Generation** (`app/services/pdf_service.py`)
```python
def _generate_qr_code(self, invoice_id: str) -> str:
    """Generate QR code as base64 data URI for verification URL."""
    verify_url = f"{settings.BACKEND_URL}/invoices/{invoice_id}/verify"
    
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_M,
        box_size=10,
        border=2,
    )
    qr.add_data(verify_url)
    qr.make(fit=True)
    
    # Convert to base64 data URI
    img = qr.make_image(fill_color="black", back_color="white")
    return f"data:image/png;base64,{base64_encoded_image}"
```

2. **Verification Endpoint** (`app/api/routes_invoice.py`)
```python
@router.get("/{invoice_id}/verify", response_model=schemas.InvoiceVerificationOut)
def verify_invoice(invoice_id: str, db: DbDep):
    """Public endpoint to verify invoice authenticity."""
    invoice = db.query(Invoice).filter(Invoice.invoice_id == invoice_id).first()
    
    if not invoice:
        raise HTTPException(status_code=404, detail="Invoice not found")
    
    # Mask customer name for privacy
    masked_name = mask_customer_name(invoice.customer.name)
    
    return {
        "invoice_id": invoice_id,
        "status": invoice.status,
        "amount": invoice.amount,
        "customer_name": masked_name,
        "business_name": invoice.issuer.name,
        "authentic": True
    }
```

3. **Customer Name Masking**
```python
# "John Doe" ‚Üí "J*****e"
# "AB" ‚Üí "A*"
# "Jane" ‚Üí "J**e"
if len(customer_name) > 2:
    masked = customer_name[0] + "*" * (len(customer_name) - 2) + customer_name[-1]
else:
    masked = customer_name[0] + "*"
```

### Frontend (Future Enhancement)

Create a public verification page at `/verify/{invoice_id}` that:
- Shows a friendly UI for verification results
- Displays business branding
- Shows invoice status with visual indicators
- Provides a "Report Fraud" button if invoice seems suspicious

## Configuration

### Environment Variables

```bash
# Backend URL used for QR code generation
BACKEND_URL=https://api.suoops.com  # Production
BACKEND_URL=http://localhost:8000   # Development
```

Update in Heroku:
```bash
heroku config:set BACKEND_URL=https://api.suoops.com
```

## Testing

### Manual Testing

1. **Create Test Invoice**
```bash
curl -X POST https://api.suoops.com/invoices \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "customer_name": "Test Customer",
    "customer_phone": "+2348012345678",
    "amount": 10000,
    "lines": [{"description": "Test Item", "quantity": 1, "unit_price": 10000}]
  }'
```

2. **Verify Invoice**
```bash
curl https://api.suoops.com/invoices/INV-XXXX-XXXX/verify
```

3. **Check PDF QR Code**
- Download generated PDF
- Look for QR code section at bottom
- Scan with phone camera
- Should open verification URL

### Automated Tests

Run test suite:
```bash
pytest tests/test_invoice_verification.py -v
```

Tests cover:
- ‚úÖ Successful verification
- ‚úÖ Invoice not found (404)
- ‚úÖ No authentication required
- ‚úÖ Customer name masking
- ‚úÖ QR code generation

## Benefits

### For Businesses
- **Build Trust**: Show customers invoices are legitimate
- **Reduce Fraud**: Only your invoices have valid QR codes
- **Save Time**: Customers can self-verify without calling
- **Professional Image**: Modern, tech-forward billing

### For Customers
- **Peace of Mind**: Verify invoice before paying
- **Check Status**: See if payment was received
- **Anti-Scam**: Detect fake invoices instantly
- **No App Required**: Works with any QR scanner

## Roadmap

### Phase 1 (‚úÖ Complete)
- [x] QR code generation in PDF
- [x] Public verification API endpoint
- [x] Customer name masking for privacy
- [x] Automated tests

### Phase 2 (Future)
- [ ] Public verification page with UI (`/verify/{invoice_id}`)
- [ ] Add business logo to verification page
- [ ] "Report Fraud" button for suspicious invoices
- [ ] Verification analytics (how many scans per invoice)

### Phase 3 (Future)
- [ ] QR code styling/branding
- [ ] Multiple QR code positions on PDF
- [ ] Short URL option (e.g., `suo.ps/v/INV-001`)
- [ ] WhatsApp verification bot integration

## Support

For issues or questions:
- Email: support@suoops.com
- Documentation: https://docs.suoops.com/qr-verification
- GitHub Issues: https://github.com/Ayibatonye-ikemike/suoops-backend/issues

## Changelog

### v1.0 (October 30, 2025)
- Initial release
- QR code generation in PDF
- Public verification endpoint
- Customer name masking
- Comprehensive tests
