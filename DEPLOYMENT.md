# SuoPay Deployment Guide

This guide will help you deploy your SuoPay application to production using Heroku (backend) and Vercel (frontend). The backend now sends signup/login OTP codes over WhatsApp, so make sure the WhatsApp Cloud API configuration is complete before going live.

## Prerequisites

Before deploying, make sure you have:

1. **Heroku CLI** installed: https://devcenter.heroku.com/articles/heroku-cli
2. **Vercel CLI** installed: `npm i -g vercel`
3. **Git** repository set up
4. Domain `suopay.io` configured
5. `.python-version` present in the repo root (currently `3.12`) so Heroku picks the latest secure Python patch automatically.

## Quick Deployment

Run the automated deployment script:

```bash
./deploy.sh
```

This script will guide you through deploying both the backend and frontend.

## Manual Deployment

### Backend to Heroku

1. **Login to Heroku:**
   ```bash
   heroku auth:login
   ```

2. **Create a new Heroku app:**
   ```bash
   heroku create suopay-backend --region us
   ```

3. **Add required addons:**
   ```bash
   heroku addons:create heroku-postgresql:mini -a suopay-backend
   heroku addons:create heroku-redis:mini -a suopay-backend
   ```

4. **Set environment variables:**
   ```bash
   heroku config:set ENV=prod -a suopay-backend
   heroku config:set APP_NAME=SuoPay -a suopay-backend
   heroku config:set WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id -a suopay-backend
   heroku config:set WHATSAPP_API_KEY=your_whatsapp_token -a suopay-backend
   heroku config:set PAYSTACK_SECRET=your_paystack_secret -a suopay-backend
   heroku config:set S3_ACCESS_KEY=your_s3_access_key -a suopay-backend
   heroku config:set S3_SECRET_KEY=your_s3_secret_key -a suopay-backend
   heroku config:set S3_BUCKET=suopay-storage -a suopay-backend
   ```

5. **Deploy:**
   ```bash
   git push heroku main
   ```

   > Heroku now reads the Python version from `.python-version`. Keep that file at the repo root and avoid reintroducing `runtime.txt` or additional lockfiles (for example `poetry.lock`) so the buildpack only sees `requirements.txt`.

6. **Run database migrations:**
   ```bash
   heroku run alembic upgrade head -a suopay-backend
   ```

   The latest migration removes password fields from the `users` table and enables WhatsApp OTP login, so this step is required after every deploy that changes the data model.

### Frontend to Vercel

1. **Navigate to frontend directory:**
   ```bash
   cd frontend
   ```

2. **Install dependencies:**
   ```bash
   npm install
   ```

3. **Deploy to Vercel:**
   ```bash
   vercel --prod
   ```

4. **Set environment variables in Vercel dashboard:**
   - `NEXT_PUBLIC_API_BASE_URL`: Your Heroku backend URL

## Domain Configuration

### Setting up suopay.io

1. **For the frontend (Vercel):**
   - Go to your Vercel dashboard
   - Navigate to your project settings
   - Add custom domain: `suopay.io` and `www.suopay.io`
   - Follow Vercel's DNS configuration instructions

2. **For the backend (Heroku):**
   - Add a subdomain like `api.suopay.io`
   - In Heroku dashboard, go to Settings > Domains
   - Add custom domain: `api.suopay.io`
   - Configure DNS records as instructed

### DNS Configuration

Add these records to your Namecheap DNS:

```
Type    Host    Value                           TTL
CNAME   www     cname.vercel-dns.com           300
CNAME   @       cname.vercel-dns.com           300
CNAME   api     your-app.herokuapp.com         300
```

## Post-Deployment Configuration

1. **Update CORS settings** in your backend config to include your production domains
2. **Configure payment provider webhooks** to point to your production API
3. **Set up monitoring** and logging for production
4. **Test all functionality** in the production environment

## Environment Variables Reference

### Backend (Heroku)
- `ENV`: `prod`
- `DATABASE_URL`: Automatically set by Heroku PostgreSQL addon
- `REDIS_URL`: Automatically set by Heroku Redis addon
- `WHATSAPP_API_KEY`: Your WhatsApp Business API token
- `WHATSAPP_PHONE_NUMBER_ID`: The phone number ID from your WhatsApp Cloud API app
- `PAYSTACK_SECRET`: Your Paystack secret key
- `JWT_SECRET`: Automatically generated by Heroku
- `S3_ACCESS_KEY`: AWS S3 access key
- `S3_SECRET_KEY`: AWS S3 secret key
- `S3_BUCKET`: Your S3 bucket name

### Frontend (Vercel)
- `NEXT_PUBLIC_API_BASE_URL`: Your backend URL (e.g., `https://api.suopay.io`)

## Troubleshooting

### Common Issues

1. **Database connection errors**: Ensure PostgreSQL addon is properly attached
2. **CORS errors**: Update CORS_ALLOW_ORIGINS in backend config
3. **Build failures**: Check that all dependencies are properly listed in requirements.txt
4. **Environment variable issues**: Verify all required variables are set
5. **OTP codes not delivered**: Confirm `WHATSAPP_API_KEY`/`WHATSAPP_PHONE_NUMBER_ID` are set and that the WhatsApp template used for OTP messages is approved

### Logs

- **Heroku logs**: `heroku logs --tail -a suopay-backend`
- **Vercel logs**: Check Vercel dashboard or use `vercel logs`

## Scaling

### Heroku
- Upgrade dyno types in Heroku dashboard
- Scale worker processes: `heroku ps:scale worker=2 -a suopay-backend`

### Vercel
- Vercel automatically scales based on usage
- Monitor usage in Vercel dashboard

## Security Checklist

- [ ] All sensitive environment variables are set
- [ ] CORS is properly configured
- [ ] HTTPS is enforced on both frontend and backend
- [ ] Database credentials are secure
- [ ] API keys are production-ready (not test keys)
- [ ] File upload size limits are configured
- [ ] Rate limiting is enabled

## Monitoring

Set up monitoring for:
- Application performance
- Error tracking
- Database performance
- API response times
- User activity

Consider using services like:
- Sentry for error tracking
- LogDNA for log management
- New Relic for application performance monitoring

## WhatsApp OTP Checklist

- Verify the WhatsApp Cloud API app has a live (non-sandbox) phone number and template approval for transactional OTP messages.
- Ensure `WHATSAPP_API_KEY` and `WHATSAPP_PHONE_NUMBER_ID` are configured in Heroku.
- If OTP delivery fails, check Heroku logs for `[WHATSAPP]` messages and confirm Redis connectivity (fallback to in-memory storage is only suitable for development).